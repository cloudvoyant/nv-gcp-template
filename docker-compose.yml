services:
  # Base image: full build environment with source and dependencies
  base:
    build:
      context: .
      dockerfile: dockerfiles/base.dockerfile
    image: ${PROJECT}-base:local

  # Web service: production-optimized for Cloud Run
  web:
    build:
      context: .
      dockerfile: dockerfiles/web.dockerfile
      args:
        - PROJECT
    image: ${GCP_DEVOPS_PROJECT_REGION}-docker.pkg.dev/${GCP_DEVOPS_PROJECT_ID}/${GCP_DEVOPS_DOCKER_REGISTRY_NAME}/${PROJECT}-web:${VERSION:-latest}
    depends_on:
      - base
    ports:
      - "8080:8080"

  # Test runner: uses base image to run tests
  tester:
    image: ${PROJECT}-base:local
    depends_on:
      - base
    command: ["just", "test"]
